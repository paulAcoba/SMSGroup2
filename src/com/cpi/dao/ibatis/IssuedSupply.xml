<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sqlmap-2.dtd">
<sqlMap namespace="IssuedSupply">
	<typeAlias alias="IssuedSupplyClass" type="com.cpi.entity.IssuedSupply" /><!-- this will initiates the xml from the entity -->
	<typeAlias alias="SupplyClass" type="com.cpi.entity.Item" />
	
	<resultMap id="allIsssuedSupplyMap" class="IssuedSupplyClass">
		<result column="issue_id" property="issueId" />
		<result column="supply_id" property="supplyId" />
		<result column="issue_date" property="issueDate" />
		<result column="requestor" property="requestor" />
		<result column="quantity" property="quantity" />
		<result column="dept_id" property="deptId" />
		<result column="last_user" property="lastUser" />
		<result column="last_update" property="lastUpdate" />
	</resultMap>
	
	<resultMap id="allItemsMap" class="SupplyClass">
		<result column="supply_id" property="supplyId" />
		<result column="item_name" property="itemName" />
		<result column="actual_count" property="actualCount" />
	</resultMap>
	
	<select id="getAllIssuedSupplies" resultMap="allIsssuedSupplyMap">
		SELECT * FROM issued_supply_2
	</select>
	
	<select id="getAllItems" resultMap="allItemsMap">
		BEGIN
			SELECT supply_id, item_name, actual_count FROM supply_2
			WHERE obsolete_tag := 'Y'
		END;
	</select>
	
	<select id="addIssuedSupplies" resultClass="java.lang.String">
		BEGIN
			INSERT INTO issued_supplies_2(issued_id,supply_id,issue_date,requestor,quantity,dept_id,last_user,last_update)
			VALUES (seq_issued_id_2.NEXTVAL,#supplyId#,#issueDate#,#requestor#,#quantity#,#deptId#,#lastUser#,#lastUpdate#);
			
			UPDATE supply_2
			SET actual_count := actual_count - #quantity#
			WHERE supply_id := #supplyId#;
		END;
	</select>
	
	<select id="updateIssuedSupplies" resultClass="java.lang.String">
		BEGIN
			UPDATE issued_supplies_2
			SET issue_date := #issueDate#,
				requestor := #quantity#,
				dept_id := #deptId#,
				last_user := #lastUser#,
				last_update := #lastUpdate#
			WHERE issue_id := #issueId#
		END;
	</select>
</sqlMap>